{"version":3,"file":"trumbowyg.service.js","sourceRoot":"","sources":["../../src/trumbowyg.service.ts"],"names":[],"mappings":"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","sourcesContent":["import {Optional, Injectable} from \"@angular/core\";\nimport {Observable} from \"rxjs/Observable\";\nimport \"rxjs/add/operator/publishReplay\";\nimport \"rxjs/add/operator/switchMap\";\nimport \"rxjs/add/operator/map\";\nimport \"rxjs/add/operator/catch\";\nimport {fromPromise} from \"rxjs/observable/fromPromise\";\nimport {of} from \"rxjs/observable/of\";\nimport {TrumbowygConfig} from \"./trumbowyg.config\";\nimport {LoadExternalFiles} from \"./load-external-file.service\";\n\nconst JQUERY_SCRIPT_URL = 'https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js';\n\ndeclare const window: any;\n\n@Injectable()\nexport class TrumbowygService {\n\n  private TRUMBOWYG_PREFIX_URL: string;\n  private TRUMBOWYG_PLUGINS_PREFIX: string;\n  private TRUMBOWYG_STYLES_URL: string;\n  private TRUMBOWYG_SCRIPT_URL: string;\n\n  private isLoaded$: Observable<boolean>;\n  private loadedLangs: Array<string> = [];\n\n  constructor(\n    private loadFiles: LoadExternalFiles,\n    @Optional() config: TrumbowygConfig\n  ) {\n    this.TRUMBOWYG_PREFIX_URL = `https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/${(config && config.version) || '2.8.0'}`;\n    this.TRUMBOWYG_PLUGINS_PREFIX = this.TRUMBOWYG_PREFIX_URL + '/plugins';\n    this.TRUMBOWYG_STYLES_URL = this.TRUMBOWYG_PREFIX_URL + '/ui/trumbowyg.min.css';\n    this.TRUMBOWYG_SCRIPT_URL = this.TRUMBOWYG_PREFIX_URL + '/trumbowyg.min.js';\n\n    const trumbowygFiles = [ this.TRUMBOWYG_STYLES_URL, this.TRUMBOWYG_SCRIPT_URL ];\n    const trumbowygPlugInFiles = this.parsePlugins(config);\n\n    const loadBasicFiles$ = window && window[\"jQuery\"] && window[\"jQuery\"]().on ?\n      fromPromise(loadFiles.load(...trumbowygFiles))\n      : fromPromise(loadFiles.load(JQUERY_SCRIPT_URL))\n        .switchMap(() =>\n          fromPromise(loadFiles.load(...trumbowygFiles))\n        );\n    const loadFiles$ = loadBasicFiles$\n      .switchMap(() =>\n        fromPromise(loadFiles.load(...trumbowygPlugInFiles))\n          .catch(err => of(err))\n      ).switchMap(() =>\n        fromPromise(loadFiles.createUploadS3())\n          .catch(err => of(err))\n      );\n\n    this.isLoaded$ = loadFiles$\n      .map(() => true)\n      .publishReplay(1)\n      .refCount();\n  }\n\n  private parsePlugins(config: TrumbowygConfig): string[] {\n    if (!config ||  !Array.isArray(config.plugins)) { return []; }\n\n    return config.plugins.reduce(\n      (acc: string[], plugin: string) => {\n        acc.push(`${this.TRUMBOWYG_PLUGINS_PREFIX}/${plugin}/trumbowyg.${plugin}.min.js`);\n        if(plugin === 'emoji' || plugin === 'colors') { //emoji doesn't work yet.\n          acc.push(`${this.TRUMBOWYG_PLUGINS_PREFIX}/${plugin}/ui/trumbowyg.${plugin}.min.css`);\n        }\n        return acc;\n      }, []);\n  }\n\n  private loadLang(lang: string): Observable<any> {\n    if(this.loadedLangs.indexOf(lang) < 0)\n      return fromPromise(\n        this.loadFiles.load(`${this.TRUMBOWYG_PREFIX_URL}/langs/${lang}.min.js`)\n          .then(() => {\n            this.loadedLangs.push(lang);\n            return true;\n          })\n      );\n    return fromPromise(Promise.resolve(true));\n  }\n\n  public loaded(lang?: string): Observable<boolean> {\n    return this.isLoaded$\n      .switchMap(() => {\n        if(lang) return this.loadLang(lang);\n        else return of(true);\n      })\n  }\n}\n\ninterface DecoratorInvocation {\n  type: Function;\n  args?: any[];\n}\n"]}