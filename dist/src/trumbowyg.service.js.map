{"version":3,"file":"trumbowyg.service.js","sourceRoot":"","sources":["../../src/trumbowyg.service.ts"],"names":[],"mappings":"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","sourcesContent":["import {Optional, Injectable} from \"@angular/core\";\nimport {Observable, from, of} from \"rxjs\";\nimport { publishReplay, switchMap, map, catchError, refCount } from \"rxjs/operators\";\nimport {TrumbowygConfig} from \"./trumbowyg.config\";\nimport {LoadExternalFiles} from \"./load-external-file.service\";\n\nconst JQUERY_SCRIPT_URL = 'https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js';\n\ndeclare const window: any;\n\n@Injectable()\nexport class TrumbowygService {\n\n  private TRUMBOWYG_PREFIX_URL: string;\n  private TRUMBOWYG_PLUGINS_PREFIX: string;\n  private TRUMBOWYG_STYLES_URL: string;\n  private TRUMBOWYG_SCRIPT_URL: string;\n\n  private isLoaded$: Observable<boolean>;\n  private loadedLangs: Array<string> = [];\n  private config: TrumbowygConfig;\n\n  constructor(\n    private loadFiles: LoadExternalFiles,\n    @Optional() config: TrumbowygConfig\n  ) {\n    this.TRUMBOWYG_PREFIX_URL = `https://cdnjs.cloudflare.com/ajax/libs/Trumbowyg/${(config && config.version) || '2.8.0'}`;\n    this.TRUMBOWYG_PLUGINS_PREFIX = this.TRUMBOWYG_PREFIX_URL + '/plugins';\n    this.TRUMBOWYG_STYLES_URL = this.TRUMBOWYG_PREFIX_URL + '/ui/trumbowyg.min.css';\n    this.TRUMBOWYG_SCRIPT_URL = this.TRUMBOWYG_PREFIX_URL + '/trumbowyg.min.js';\n    this.config = config;\n  }\n\n  public load(serverPath: string) {\n    const trumbowygFiles = [ this.TRUMBOWYG_STYLES_URL, this.TRUMBOWYG_SCRIPT_URL ];\n    const trumbowygPlugInFiles = this.parsePlugins(this.config, serverPath);\n\n    const loadBasicFiles$ = window && window[\"jQuery\"] && window[\"jQuery\"]().on ?\n      from(this.loadFiles.load(...trumbowygFiles))\n      : from(this.loadFiles.load(JQUERY_SCRIPT_URL))\n        .pipe(\n          switchMap(() =>\n            from(this.loadFiles.load(...trumbowygFiles))\n          )\n        );\n    const loadFiles$ = loadBasicFiles$\n      .pipe(\n        switchMap(() =>\n          from(this.loadFiles.load(...trumbowygPlugInFiles))\n            .pipe(catchError(err => of(err)))\n        )\n      );\n\n    this.isLoaded$ = loadFiles$\n      .pipe(\n        map(() => true),\n        publishReplay(1),\n        refCount()\n      );\n  }\n\n  private parsePlugins(config: TrumbowygConfig, serverPath: string): string[] {\n    if (!config ||  !Array.isArray(config.plugins)) { return []; }\n\n    return config.plugins.reduce(\n      (acc: string[], plugin: string) => {\n        if (plugin === 'uploads3' && serverPath !== '') {\n          acc.push(serverPath)\n        } else {\n          acc.push(`${this.TRUMBOWYG_PLUGINS_PREFIX}/${plugin}/trumbowyg.${plugin}.min.js`);\n        }\n        if(plugin === 'emoji' || plugin === 'colors') { //emoji doesn't work yet.\n          acc.push(`${this.TRUMBOWYG_PLUGINS_PREFIX}/${plugin}/ui/trumbowyg.${plugin}.min.css`);\n        }\n        return acc;\n      }, []);\n  }\n\n  private loadLang(lang: string): Observable<any> {\n    if(this.loadedLangs.indexOf(lang) < 0)\n      return from(\n        this.loadFiles.load(`${this.TRUMBOWYG_PREFIX_URL}/langs/${lang}.min.js`)\n          .then(() => {\n            this.loadedLangs.push(lang);\n            return true;\n          })\n      );\n    return from(Promise.resolve(true));\n  }\n\n  public loaded(lang?: string): Observable<boolean> {\n    return this.isLoaded$\n      .pipe(\n        switchMap(() => {\n          if(lang) return this.loadLang(lang);\n          else return of(true);\n        })\n      )\n  }\n}\n;"]}